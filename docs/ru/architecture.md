# Архитектура

## Общая концепция

Проект построен на принципах **чистой архитектуры** (Clean Architecture) с использованием паттерна **Порты и Адаптеры** (Ports & Adapters). Ядро системы (`core`) полностью изолировано от внешних зависимостей и знает только о бизнес-логике.

## Граф зависимостей

```
app → runtime → (features, agents, storage, providers, llm) → core
```

**Ключевое правило**: `core` не знает о внешних интеграциях. Внешние модули реализуют интерфейсы из `core/ports`.

## Слои архитектуры

### 1. Ядро (`src/core/`)

**Назначение**: Доменная логика без внешних зависимостей (только stdlib).

#### `core/models/`
Доменные модели данных:
- `Candle` — свеча с OHLCV данными
- `Timeframe` — таймфрейм (1m, 5m, 1h, 1d и т.д.)
- `Recommendation` — торговая рекомендация
- `Rationale` — обоснование рекомендации
- `DecisionContext` — контекст для принятия решения
- `JournalEntry` — запись в журнале сделок
- `Outcome` — результат сделки
- `Signal` — торговый сигнал
- `Run` — метаданные запуска анализа

#### `core/ports/`
Абстрактные интерфейсы (ABC) для внешних зависимостей:
- `MarketDataProvider` — получение рыночных данных
- `NewsProvider` — получение новостей
- `LlmProvider` — взаимодействие с LLM
- `Storage` — интерфейсы репозиториев
- `Clock` — абстракция времени

#### `core/policies/`
Бизнес-правила и политики:
- `SafetyPolicy` — проверка безопасности рекомендаций
- `Constraints` — ограничения и валидация

#### `core/services/`
Доменные сервисы:
- `Orchestrator` — оркестрация пайплайна анализа
- `Reporter` — генерация отчетов
- `Scheduler` — планирование задач

**Правило**: `core` не импортирует ничего извне, кроме stdlib.

### 2. Провайдеры данных (`src/data_providers/`, `src/news_providers/`)

**Назначение**: Реализация интерфейсов из `core/ports` для получения внешних данных.

#### Реализации:
- `OandaProvider` → `MarketDataProvider`
- `TwelveDataProvider` → `MarketDataProvider`
- `FallbackMarketDataProvider` → автоматическое переключение между провайдерами
- `GDELTProvider` → `NewsProvider`
- `NewsAPIProvider` → `NewsProvider` (планируется)

**Правило**: Провайдеры не знают друг о друге и не импортируют `features`, `agents`, `runtime`.

### 3. Вычисление признаков (`src/features/`)

**Назначение**: Расчет технических индикаторов и анализ рыночных данных.

#### Модули:
- `indicators/` — расчет индикаторов (RSI, MACD, Bollinger Bands и т.д.)
- `volatility/` — оценка волатильности
- `regime/` — определение режима рынка (тренд, флэт)
- `snapshots/` — снимки признаков для передачи агентам

**Зависимости**: `pandas`, `numpy`, `ta`, `core.models`

**Правило**: `features` не знает о провайдерах, хранилище и runtime.

### 4. LLM-агенты (`src/agents/`)

**Назначение**: Использование LLM для анализа и генерации рекомендаций.

#### Агенты:
- `TechnicalAnalyst` — технический анализ через LLM
- `Synthesizer` — синтез финальной рекомендации
- `NewsSentimentAnalyst` — анализ новостей (планируется)

**Зависимости**: `core.ports.llm_provider` (интерфейс), `core.models`, `features.snapshots`

**Правило**: Агенты не пишут в БД и не управляют циклом выполнения.

### 5. LLM провайдеры (`src/llm/`)

**Назначение**: Реализация `LlmProvider` для конкретных LLM сервисов.

#### Реализации:
- `OllamaClient` → `LlmProvider` (локальный или удаленный Ollama)

**Правило**: Агентам все равно, где находится LLM — они видят только интерфейс.

### 6. Хранилище (`src/storage/`)

**Назначение**: Персистентность данных через SQLite.

#### Компоненты:
- `sqlite/repositories/` — репозитории для различных сущностей
- `sqlite/connection.py` — управление подключением
- `sqlite/migrations/` — миграции БД
- `artifacts/` — хранилище отчетов и логов

**Правило**: `storage` не знает о `runtime`, `ui`, `providers`.

### 7. Оркестрация (`src/runtime/`)

**Назначение**: Связывание всех компонентов и выполнение задач.

#### Компоненты:
- `jobs/` — задачи выполнения:
  - `FetchMarketDataJob` — получение рыночных данных
  - `FetchNewsJob` — получение новостей
  - `BuildFeaturesJob` — расчет признаков
  - `RunAgentsJob` — запуск агентов
  - `PersistRecommendationJob` — сохранение рекомендаций
- `loop/` — циклы выполнения (например, `MinuteLoop`)

**Правило**: `runtime` — единственное место, где разрешено связывать конкретные реализации.

### 8. Точка входа (`src/app/`)

**Назначение**: Инициализация приложения и CLI интерфейс.

#### Компоненты:
- `main.py` — CLI команды
- `wiring.py` — Dependency Injection (создание и связывание компонентов)
- `settings.py` — конфигурация через pydantic-settings

**Правило**: `app` знает о `runtime` и использует `wiring` для создания зависимостей.

### 9. Интерфейс (`src/ui/`)

**Назначение**: Отображение данных пользователю.

#### Компоненты:
- `cli/dashboard.py` — CLI дашборд
- `cli/renderers/` — рендереры для различных типов данных

**Зависимости**: `rich` для форматирования

**Правило**: `ui` не импортирует провайдеры напрямую, только `runtime` и `core.models`.

## Поток выполнения анализа

```
1. CLI (main.py)
   └─> analyze(symbol, timeframe)
       └─> wiring.py создает компоненты
           └─> RunAgentsJob.run()
               ├─> FetchMarketDataJob → получает свечи
               ├─> BuildFeaturesJob → вычисляет индикаторы
               ├─> TechnicalAnalyst → анализирует через LLM
               ├─> FetchNewsJob → получает новости
               ├─> Synthesizer → синтезирует рекомендацию
               └─> PersistRecommendationJob → сохраняет в БД
```

## Dependency Injection

Все зависимости создаются в `src/app/wiring.py`:

```python
def create_market_data_provider() -> MarketDataProvider:
    # Создает провайдеры и связывает их
    return FallbackMarketDataProvider(...)

def create_technical_analyst() -> TechnicalAnalyst:
    llm_provider = create_llm_provider()
    return TechnicalAnalyst(llm_provider=llm_provider)
```

Это позволяет:
- Легко менять реализации
- Тестировать компоненты изолированно
- Избегать циклических зависимостей

## Преимущества архитектуры

1. **Тестируемость**: Ядро можно тестировать без внешних зависимостей
2. **Расширяемость**: Новые провайдеры добавляются через реализацию интерфейсов
3. **Переносимость**: Ядро не привязано к конкретным технологиям
4. **Изоляция**: Изменения во внешних слоях не затрагивают ядро
5. **Читаемость**: Четкое разделение ответственности

## Правила импортов

Подробные правила импортов и граф зависимостей см. в [Правила импортов](import_rules.md).

## Расширение системы

### Добавление нового провайдера данных

1. Создать класс, реализующий `MarketDataProvider`
2. Добавить создание в `wiring.py`
3. Ядро остается неизменным

### Добавление нового агента

1. Создать класс в `src/agents/`
2. Использовать `LlmProvider` через интерфейс
3. Добавить в `RunAgentsJob` при необходимости

### Добавление нового индикатора

1. Добавить расчет в `features/indicators/`
2. Обновить `FeatureSnapshot` при необходимости
3. Агенты автоматически получат новые данные